const http=require('http');const https=require('https');const{parse}=require('node-html-parser');const ft=async u=>{for(let i=0;i<3;i++){try{return await new Promise((rs,rj)=>{https.get(u,{headers:{'User-Agent':'Mozilla/5.0'},timeout:30000},(r)=>{let d='';r.on('data',c=>d+=c);r.on('end',()=>{try{rs(JSON.parse(d))}catch{rj(new Error('Invalid JSON'))}});r.on('error',rj)}).on('error',rj)})}catch{}}return null};const fh=u=>new Promise((rs,rj)=>{https.get(u,{headers:{'User-Agent':'Mozilla/5.0'},timeout:30000},(r)=>{let d='';r.on('data',c=>d+=c);r.on('end',()=>rs(d));r.on('error',rj)}).on('error',rj)});const q=(r,s)=>r.querySelector(s)?.textContent;const p=v=>{if(!v||v==='-')return 0;const n=parseFloat(v.replace(/[,$]/g,'')),m=v.toLowerCase();return n*(m.includes('k')?1e3:m.includes('m')?1e6:m.includes('b')?1e9:1)};const fm=n=>n>=1e9?`$${(n/1e9).toFixed(1)}B`:n>=1e6?`$${(n/1e6).toFixed(1)}M`:n>=1e3?`$${(n/1e3).toFixed(1)}K`:`$${n.toFixed(0)}`;const f=t=>{if(p(t.mcap)<1e5)return 0;const c=[t.change5m,t.change1h,t.change6h,t.change24h].map(x=>x&&x!=='-'?Math.abs(parseFloat(x)):null).filter(x=>x!==null);return c.length>2&&new Set(c).size===c.length};const rq=[];const rl=()=>{const n=Date.now(),o=rq.filter(t=>n-t<60000);rq.length=0;rq.push(...o);return o.length<60};const getTokensHTML=async(c='solana',pg=1)=>{const h=await fh(pg>1?`https://dexscreener.com/${c}/page-${pg}`:`https://dexscreener.com/${c}`);const d=parse(h);return[...d.querySelectorAll('a.ds-dex-table-row')].map(r=>{const hr=r.getAttribute('href'),s=q(r,'.ds-dex-table-row-base-token-symbol'),i=r.querySelector('.ds-dex-table-row-token-icon-img')?.getAttribute('src'),a=i?.match(/\/tokens\/solana\/([^.]+)/)?.[1];return hr&&s&&a?{url:`https://dexscreener.com${hr}`,address:a,symbol:s,name:q(r,'.ds-dex-table-row-base-token-name'),mcap:q(r,'.ds-dex-table-row-col-market-cap'),fdv:q(r,'.ds-dex-table-row-col-fdv'),price:q(r,'.ds-dex-table-row-col-price'),change5m:q(r,'.ds-dex-table-row-col-price-change-m5 .ds-change-perc'),change1h:q(r,'.ds-dex-table-row-col-price-change-h1 .ds-change-perc'),change6h:q(r,'.ds-dex-table-row-col-price-change-h6 .ds-change-perc'),change24h:q(r,'.ds-dex-table-row-col-price-change-h24 .ds-change-perc'),volume:q(r,'.ds-dex-table-row-col-volume'),liquidity:q(r,'.ds-dex-table-row-col-liquidity'),txns:q(r,'.ds-dex-table-row-col-txns'),makers:q(r,'.ds-dex-table-row-col-makers'),age:q(r,'.ds-dex-table-row-col-pair-age'),chain:c,timestamp:new Date().toISOString()}:null}).filter(t=>t&&f(t))};const ba=async(ts,c='solana')=>{const rs=[],fl=[],bs=30,pc=3;for(let i=0;i<ts.length;i+=bs*pc){const bt=[];for(let j=0;j<pc&&i+j*bs<ts.length;j++){bt.push(ts.slice(i+j*bs,i+(j+1)*bs))}const pr=bt.map(async b=>{if(!rl())await new Promise(r=>setTimeout(r,1000));rq.push(Date.now());const ads=b.map(t=>t.address).join(','),d=await ft(`https://api.dexscreener.com/tokens/v1/${c}/${ads}`);if(d){b.forEach(tk=>{const ad=d.find(x=>x.baseToken?.address.toLowerCase()===tk.address.toLowerCase());if(ad){const so={};ad.info?.websites?.forEach(w=>so[w.label.toLowerCase()]=w.url);ad.info?.socials?.forEach(x=>so[x.type]=x.url);rs.push({...tk,fdv:fm(ad.fdv||0),priceNative:ad.priceNative,volume:{m5:fm(ad.volume?.m5||0),h1:fm(ad.volume?.h1||0),h6:fm(ad.volume?.h6||0),h24:fm(ad.volume?.h24||0)},txns:{m5:ad.txns?.m5,h1:ad.txns?.h1,h6:ad.txns?.h6,h24:ad.txns?.h24},boosts:ad.boosts?.active||0,social:Object.keys(so).length?so:null})}else fl.push(tk)})}else fl.push(...b)});await Promise.all(pr)}if(fl.length){const rt=await ba(fl,c);rs.push(...rt)}return rs};const getAllTokens=async(c='solana')=>{const a=[],b=40;let pg=1,h=1;while(h){const r=await Promise.all([...Array(b)].map((_,i)=>getTokensHTML(c,pg+i)));h=r.reduce((s,t)=>(a.push(...t),s+t.length),0);pg+=b;h&&await new Promise(r=>setTimeout(r,50))}return await ba(a,c)};const server=http.createServer(async(req,res)=>{if(req.url==='/'){try{res.writeHead(200,{'Content-Type':'application/json'});const data=await getAllTokens('solana');res.end(JSON.stringify(data))}catch(e){res.writeHead(500,{'Content-Type':'application/json'});res.end(JSON.stringify({error:'Failed to fetch data'}))}}else{res.writeHead(404);res.end('Not found')}});server.listen(process.env.PORT||3000,()=>{});
