addEventListener('fetch',e=>e.respondWith(h(e.request)));async function h(request){const url=new URL(request.url);const startPage=parseInt(url.searchParams.get('start'));const endPage=parseInt(url.searchParams.get('end'));const isSingle=url.searchParams.has('start');if(!isSingle){return new Response(`<!DOCTYPE html><html><head><title>Token Scanner</title></head><body><h1>Scanning 220 pages...</h1><div id="status">Starting...</div><pre id="results"></pre><script>async function scan(){const status=document.getElementById('status');const results=document.getElementById('results');const promises=[];for(let i=0;i<22;i++){const start=i*10+1;const end=start+9;promises.push(fetch('${url.origin}${url.pathname}?start='+start+'&end='+end).then(r=>r.json()))}status.textContent='Processing '+promises.length+' batches...';try{const allResults=await Promise.all(promises);const combined=allResults.flat();status.textContent='Found '+combined.length+' tokens';results.textContent=JSON.stringify(combined,null,2)}catch(e){status.textContent='Error: '+e.message}}scan()</script></body></html>`,{headers:{'Content-Type':'text/html'}})}const q=(s,c)=>{const patterns={'ds-dex-table-row-base-token-symbol':/>([^<]+)<\/span>/,'ds-dex-table-row-base-token-name':/>([^<]+)<\/span>/,'ds-dex-table-row-col-market-cap':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-fdv':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-price':/>(\$<!--\s*-->[\d.,]+)/,'ds-dex-table-row-col-volume':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-liquidity':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-pair-age':/<span>([^<]+)<\/span>/,'ds-change-perc':/>([^<]+)<\/span>/};const p=patterns[c]||/>([^<]*)/;const m=s.match(new RegExp(`class="[^"]*${c}[^"]*"[^>]*[\\s\\S]*?${p.source}`));return m?.[1]?.replace(/<!--\s*-->/g,'')?.trim()},p=v=>!v||v==='-'?0:parseFloat(v.replace(/[,$]/g,''))*(v.toLowerCase().includes('k')?1e3:v.toLowerCase().includes('m')?1e6:v.toLowerCase().includes('b')?1e9:1),f=t=>p(t.mcap)>=1e5&&p(t.liquidity)>=2e4,rq=[],r=()=>{const n=Date.now();rq.splice(0);rq.push(...rq.filter(t=>n-t<6e4));return rq.length<60},api=async u=>{for(let i=0;i<3;i++){try{const x=await fetch(u);if(x.ok)return x.json()}catch{}}},gt=async(c,g)=>{const h=await(await fetch(g>1?`https://dexscreener.com/${c}/page-${g}`:`https://dexscreener.com/${c}`,{headers:{'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}})).text();return(h.match(/<a[^>]*class="[^"]*ds-dex-table-row[^"]*"[^>]*>([\s\S]*?)<\/a>/g)||[]).map(x=>{const a=x.match(/\/tokens\/solana\/([^.]+)/)?.[1],s=q(x,'ds-dex-table-row-base-token-symbol');return a&&s?{url:`https://dexscreener.com${x.match(/href="([^"]*)"/)?.[1]}`,address:a,symbol:s,name:q(x,'ds-dex-table-row-base-token-name')||s,mcap:q(x,'ds-dex-table-row-col-market-cap')||'0',fdv:q(x,'ds-dex-table-row-col-fdv')||'0',price:q(x,'ds-dex-table-row-col-price')||'0',change5m:q(x,'ds-change-perc'),change1h:'0',change6h:'0',change24h:'0',volume:q(x,'ds-dex-table-row-col-volume')||'0',liquidity:q(x,'ds-dex-table-row-col-liquidity')||'0',txns:q(x,'ds-dex-table-row-col-txns')||'0',makers:q(x,'ds-dex-table-row-col-makers')||'0',age:q(x,'ds-dex-table-row-col-pair-age')||'0',chain:c,timestamp:new Date().toISOString()}:null}).filter(t=>t&&f(t))},en=async ts=>{const rs=[];for(let i=0;i<ts.length;i+=30){if(!r())await new Promise(x=>setTimeout(x,1e3));rq.push(Date.now());const d=await api(`https://api.dexscreener.com/tokens/v1/solana/${ts.slice(i,i+30).map(t=>t.address).join(',')}`);if(d)ts.slice(i,i+30).forEach(t=>{const a=d.find(x=>x.baseToken?.address.toLowerCase()===t.address.toLowerCase());if(a){const s={};a.info?.websites?.forEach(w=>s[w.label.toLowerCase()]=w.url);a.info?.socials?.forEach(x=>s[x.type]=x.url);rs.push({...t,fdv:a.fdv>=1e9?`$${(a.fdv/1e9).toFixed(1)}B`:a.fdv>=1e6?`$${(a.fdv/1e6).toFixed(1)}M`:`$${(a.fdv/1e3).toFixed(1)}K`,priceNative:a.priceNative,volume:{m5:a.volume?.m5||0,h1:a.volume?.h1||0,h6:a.volume?.h6||0,h24:a.volume?.h24||0},txns:{m5:a.txns?.m5||0,h1:a.txns?.h1||0,h6:a.txns?.h6||0,h24:a.txns?.h24||0},boosts:a.boosts?.active||0,social:Object.keys(s).length?s:null})}else rs.push(t)})}return rs};try{const a=[],s=new Set();for(let g=startPage;g<=endPage;g++){const r=await gt('solana',g);r.forEach(t=>{if(!s.has(t.address)){s.add(t.address);a.push(t)}});await new Promise(x=>setTimeout(x,50))}const data=await en(a);return new Response(JSON.stringify(data,null,2),{headers:{'Content-Type':'application/json'}})}catch(e){return new Response(JSON.stringify({error:e.message},null,2),{headers:{'Content-Type':'application/json'}})}}
