const express=require('express');const{JSDOM}=require('jsdom');const app=express();const PORT=process.env.PORT||3000;async function sendToSheet(d){let b=btoa,r=/[=+/]/g,x={'+':'-','/':'_','=':''},j=JSON.stringify,n=Date.now()/1e3|0,h=b(j({alg:'RS256',typ:'JWT'})).replace(r,m=>x[m]),p=b(j({iss:"tokens@formal-fragment-440604-p0.iam.gserviceaccount.com",scope:'https://www.googleapis.com/auth/spreadsheets',aud:'https://oauth2.googleapis.com/token',exp:n+3600,iat:n})).replace(r,m=>x[m]),k="MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQC6qsMhR5G56nRCLTq0Dj9vskR2trWnDQ5Z77sctmX2XwhcsfRjd2RI7fq5WKXjEvbqQnk4GCuMHBBcZntokfFCIgTKvCfL0pbGLA3w5oeR3u03WIY9sa+uqOTw9Mfx+OYBGb7akpYQFypjmWxwJ2t/nsNveAIkCW6bNeD6a0Ig3ks1B5iza6oScpecouKHzUUpcvB5DIOAae9UZHUZ9yARy+NGXfyQ68x+qF3kefbb5GYlAbaBRIU/Ot6dPfaFf15/T0Qm+y/LCrBjGjYSRqd1gu0nzyfOaVWK10pWjmy99yoZc2yAM9S2rkpzYbs42pkaWgpzVUKL/iPdszdiLrRDAgMBAAECggEARrptNS7pCIjNhEWe+JptbuUdC94u9hz8UxeCzl5ORAu+H2FOOGIEnZ2OYqw0LtYAuMJ3K8n8thnsGRa7q+Oghm5dYnPooFIqzuviXGT8+Uh+mXnxY27wIj3cgXA+UnD8tW4L4sWoFnCwnwyDCfvlv3Vol9Pg+8aXIjhIBpqdc9YgveKJCtIIGKxl2ZS9iS4zKuqDJ5YVmCRPH6zJLpkIsVYKKIHiAdsyA/d5GuVSIXRLR4p/Z5O9nBocqTpQZpU1lFiuus1rxwUqZyqqyKWtrfJKMStAOI1Ge78+Ao/lfY0jPj3cDS5+YVLvFAnTc9X6PAD5C+8IXhtFCFTHg2vYAQKBgQDnLJ/VWDlrBSYBguseMt9urMc8QZ9KoxMerawJIfTfjTC4+jD3JOJFjz9a983Hik0C2d/LxY+3+mCwY0Y35sHvhujVGptDsMOQy2xGVVjI2meSIBkMGXL86aWyy1bRJ38hlJhUzHR4QocH3uaRk5SHn8MhUzfnKqZhBULA2xR5JQKBgQDOto6emZj6pyZVYQgGAK8x8H0LH2nzxP1WjF7tqnXOREoOmehLUlWHRhNEtupmq+q4cyfIkUg2V73iUNLcoaa1zLTq44HVdXwOo/+Q28UP41rG3um5B0whHS0Jq2dcG+KU8A+a4yTZpsdrvsfzkQ2CxyzL9iJtDyk2micQAp0/RwKBgEatoQx0VdG/mDgcE9B+00seLifhFFeYdi8KADAmnpx+qWfUroXRVBDaVA929gZM5XC6ti6x71fbiBZFs+FBfwfBoowM/215rMEnQKpcS7HU/JdzktTdLwfeU5fPjXKS9c6JhO1gOTfPd0NTxgC6M04n7VvR+qSFqKq/FgKquJ61AoGAD706srzDNyKO+qU+tSZMMKM9AiHMMXFoULSzbaky+xecA+yYEVQdiwU85lh/FH42iwDJoK3fL7QSky7QP1hXlzQU+mWENzqQzZSTGvaA1Krc+JN0fFAf7c2I5lmUryC4adq1dXeiEKhwOrX2B4ed3b1InecJzAABhVTLcJ6iVnUCgYBfMKdx5YHZHpToa53y46/lAmVuhUp58WgLS/JEK3A+cSArU8F06H5dZdNu61n8GKJASnL0YQdtTicQETHDKxXZs84AkALT0/xXSWIZYz//BRGQJHo+ooP1V9U3XrqMhggjc4yAgONZ4PFReiod7klyAVCdcAZzq7CyInPLqd0I3g==",s=b(String.fromCharCode(...new Uint8Array(await crypto.subtle.sign('RSASSA-PKCS1-v1_5',await crypto.subtle.importKey('pkcs8',Uint8Array.from(atob(k),c=>c.charCodeAt(0)),{name:'RSASSA-PKCS1-v1_5',hash:'SHA-256'},0,['sign']),new TextEncoder().encode(`${h}.${p}`))))).replace(r,m=>x[m]);await fetch('https://sheets.googleapis.com/v4/spreadsheets/1MLTE4yIA5Sk-n2TdyvWy7BBTF3EF2an0mSdFHupCeU0/values:batchUpdate',{method:'POST',headers:{Authorization:`Bearer ${(await(await fetch('https://oauth2.googleapis.com/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${h}.${p}.${s}`})).json()).access_token}`,'Content-Type':'application/json'},body:j({data:[{range:'A1:AG1',values:[['url','address','symbol','name','mcap','fdv','price','change5m','change1h','change6h','change24h','volume_m5','volume_h1','volume_h6','volume_h24','liquidity','txns_m5_buys','txns_m5_sells','txns_h1_buys','txns_h1_sells','txns_h6_buys','txns_h6_sells','txns_h24_buys','txns_h24_sells','makers','age','chain','timestamp','priceNative','boosts','social_website','social_twitter','social_telegram']]},{range:'A2:AG'+(d.length+1),values:d.map(i=>[i.url,i.address,i.symbol,i.name,i.mcap,i.fdv,i.price,i.change5m,i.change1h,i.change6h,i.change24h,i.volume.m5,i.volume.h1,i.volume.h6,i.volume.h24,i.liquidity,i.txns.m5.buys,i.txns.m5.sells,i.txns.h1.buys,i.txns.h1.sells,i.txns.h6.buys,i.txns.h6.sells,i.txns.h24.buys,i.txns.h24.sells,i.makers,i.age,i.chain,i.timestamp,i.priceNative,i.boosts||0,i.social?.website||'',i.social?.twitter||'',i.social?.telegram||''])}],valueInputOption:'RAW'})})}async function scrapeData(){const q=(r,s)=>r.querySelector(s)?.textContent,p=v=>{if(!v||v==='-')return 0;const n=parseFloat(v.replace(/[,$]/g,'')),m=v.toLowerCase();return n*(m.includes('k')?1e3:m.includes('m')?1e6:m.includes('b')?1e9:1)},fm=n=>n>=1e9?`$${(n/1e9).toFixed(1)}B`:n>=1e6?`$${(n/1e6).toFixed(1)}M`:n>=1e3?`$${(n/1e3).toFixed(1)}K`:`$${n.toFixed(0)}`,f=t=>{if(p(t.mcap)<1e5)return 0;const c=[t.change5m,t.change1h,t.change6h,t.change24h].map(x=>x&&x!=='-'?Math.abs(parseFloat(x)):null).filter(x=>x!==null);return c.length>2&&new Set(c).size===c.length},rq=[],rl=()=>{const n=Date.now(),o=rq.filter(t=>n-t<60000);rq.splice(0);rq.push(...o);return o.length<60},ft=async u=>{for(let i=0;i<3;i++){try{const x=await fetch(u);if(x.ok)return await x.json()}catch{}}return null},getTokensHTML=async(c='solana',pg=1)=>{const html=await(await fetch(pg>1?`https://dexscreener.com/${c}/page-${pg}`:`https://dexscreener.com/${c}`,{headers:{'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}})).text();const dom=new JSDOM(html);return[...dom.window.document.querySelectorAll('a.ds-dex-table-row')].map(r=>{const h=r.getAttribute('href'),s=q(r,'.ds-dex-table-row-base-token-symbol'),a=r.querySelector('.ds-dex-table-row-token-icon-img')?.src?.match(/\/tokens\/solana\/([^.]+)/)?.[1];return h&&s&&a?{url:`https://dexscreener.com${h}`,address:a,symbol:s,name:q(r,'.ds-dex-table-row-base-token-name'),mcap:q(r,'.ds-dex-table-row-col-market-cap'),fdv:q(r,'.ds-dex-table-row-col-fdv'),price:q(r,'.ds-dex-table-row-col-price'),change5m:q(r,'.ds-dex-table-row-col-price-change-m5 .ds-change-perc'),change1h:q(r,'.ds-dex-table-row-col-price-change-h1 .ds-change-perc'),change6h:q(r,'.ds-dex-table-row-col-price-change-h6 .ds-change-perc'),change24h:q(r,'.ds-dex-table-row-col-price-change-h24 .ds-change-perc'),volume:q(r,'.ds-dex-table-row-col-volume'),liquidity:q(r,'.ds-dex-table-row-col-liquidity'),txns:q(r,'.ds-dex-table-row-col-txns'),makers:q(r,'.ds-dex-table-row-col-makers'),age:q(r,'.ds-dex-table-row-col-pair-age'),chain:c,timestamp:new Date().toISOString()}:null}).filter(t=>t&&f(t))},ba=async(ts,c='solana')=>{const rs=[],fl=[],bs=30,pc=3;for(let i=0;i<ts.length;i+=bs*pc){const bt=[];for(let j=0;j<pc&&i+j*bs<ts.length;j++){bt.push(ts.slice(i+j*bs,i+(j+1)*bs))}const pr=bt.map(async b=>{if(!rl())await new Promise(r=>setTimeout(r,1000));rq.push(Date.now());const ads=b.map(t=>t.address).join(','),d=await ft(`https://api.dexscreener.com/tokens/v1/${c}/${ads}`);if(d){b.forEach(tk=>{const ad=d.find(x=>x.baseToken?.address.toLowerCase()===tk.address.toLowerCase());if(ad){const so={};ad.info?.websites?.forEach(w=>so[w.label.toLowerCase()]=w.url);ad.info?.socials?.forEach(x=>so[x.type]=x.url);rs.push({...tk,fdv:fm(ad.fdv||0),priceNative:ad.priceNative,volume:{m5:ad.volume?.m5||0,h1:ad.volume?.h1||0,h6:ad.volume?.h6||0,h24:ad.volume?.h24||0},txns:{m5:ad.txns?.m5,h1:ad.txns?.h1,h6:ad.txns?.h6,h24:ad.txns?.h24},boosts:ad.boosts?.active||0,social:Object.keys(so).length?so:null})}else fl.push(tk)})}else fl.push(...b)});await Promise.all(pr)}if(fl.length){const rt=await ba(fl,c);rs.push(...rt)}return rs};try{const a=[];for(let pg=1;pg<=10;pg++){const r=await getTokensHTML('solana',pg);a.push(...r);await new Promise(x=>setTimeout(x,50))}const data=await ba(a,'solana');await sendToSheet(data);return data}catch(e){throw new Error(e.message)}}app.get('/',async(req,res)=>{try{const data=await scrapeData();res.json({success:true,count:data.length,message:'Data scraped and sent to Google Sheets'})}catch(e){res.status(500).json({error:e.message})}});app.listen(PORT,()=>console.log(`Server running on port ${PORT}`));
