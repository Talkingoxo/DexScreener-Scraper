async function sendToSheet(d){let b=btoa,r=/[=+/]/g,x={'+':'-','/':'_','=':''},j=JSON.stringify,n=Date.now()/1e3|0,h=b(j({alg:'RS256',typ:'JWT'})).replace(r,m=>x[m]),p=b(j({iss:"tokens@formal-fragment-440604-p0.iam.gserviceaccount.com",scope:'https://www.googleapis.com/auth/spreadsheets',aud:'https://oauth2.googleapis.com/token',exp:n+3600,iat:n})).replace(r,m=>x[m]),k="MIIEvAIBADANBgkqhkiG9w0BAQEFAASCBKYwggSiAgEAAoIBAQC6qsMhR5G56nRCLTq0Dj9vskR2trWnDQ5Z77sctmX2XwhcsfRjd2RI7fq5WKXjEvbqQnk4GCuMHBBcZntokfFCIgTKvCfL0pbGLA3w5oeR3u03WIY9sa+uqOTw9Mfx+OYBGb7akpYQFypjmWxwJ2t/nsNveAIkCW6bNeD6a0Ig3ks1B5iza6oScpecouKHzUUpcvB5DIOAae9UZHUZ9yARy+NGXfyQ68x+qF3kefbb5GYlAbaBRIU/Ot6dPfaFf15/T0Qm+y/LCrBjGjYSRqd1gu0nzyfOaVWK10pWjmy99yoZc2yAM9S2rkpzYbs42pkaWgpzVUKL/iPdszdiLrRDAgMBAAECggEARrptNS7pCIjNhEWe+JptbuUdC94u9hz8UxeCzl5ORAu+H2FOOGIEnZ2OYqw0LtYAuMJ3K8n8thnsGRa7q+Oghm5dYnPooFIqzuviXGT8+Uh+mXnxY27wIj3cgXA+UnD8tW4L4sWoFnCwnwyDCfvlv3Vol9Pg+8aXIjhIBpqdc9YgveKJCtIIGKxl2ZS9iS4zKuqDJ5YVmCRPH6zJLpkIsVYKKIHiAdsyA/d5GuVSIXRLR4p/Z5O9nBocqTpQZpU1lFiuus1rxwUqZyqqyKWtrfJKMStAOI1Ge78+Ao/lfY0jPj3cDS5+YVLvFAnTc9X6PAD5C+8IXhtFCFTHg2vYAQKBgQDnLJ/VWDlrBSYBguseMt9urMc8QZ9KoxMerawJIfTfjTC4+jD3JOJFjz9a983Hik0C2d/LxY+3+mCwY0Y35sHvhujVGptDsMOQy2xGVVjI2meSIBkMGXL86aWyy1bRJ38hlJhUzHR4QocH3uaRk5SHn8MhUzfnKqZhBULA2xR5JQKBgQDOto6emZj6pyZVYQgGAK8x8H0LH2nzxP1WjF7tqnXOREoOmehLUlWHRhNEtupmq+q4cyfIkUg2V73iUNLcoaa1zLTq44HVdXwOo/+Q28UP41rG3um5B0whHS0Jq2dcG+KU8A+a4yTZpsdrvsfzkQ2CxyzL9iJtDyk2micQAp0/RwKBgEatoQx0VdG/mDgcE9B+00seLifhFFeYdi8KADAmnpx+qWfUroXRVBDaVA929gZM5XC6ti6x71fbiBZFs+FBfwfBoowM/215rMEnQKpcS7HU/JdzktTdLwfeU5fPjXKS9c6JhO1gOTfPd0NTxgC6M04n7VvR+qSFqKq/FgKquJ61AoGAD706srzDNyKO+qU+tSZMMKM9AiHMMXFoULSzbaky+xecA+yYEVQdiwU85lh/FH42iwDJoK3fL7QSky7QP1hXlzQU+mWENzqQzZSTGvaA1Krc+JN0fFAf7c2I5lmUryC4adq1dXeiEKhwOrX2B4ed3b1InecJzAABhVTLcJ6iVnUCgYBfMKdx5YHZHpToa53y46/lAmVuhUp58WgLS/JEK3A+cSArU8F06H5dZdNu61n8GKJASnL0YQdtTicQETHDKxXZs84AkALT0/xXSWIZYz//BRGQJHo+ooP1V9U3XrqMhggjc4yAgONZ4PFReiod7klyAVCdcAZzq7CyInPLqd0I3g==",s=b(String.fromCharCode(...new Uint8Array(await crypto.subtle.sign('RSASSA-PKCS1-v1_5',await crypto.subtle.importKey('pkcs8',Uint8Array.from(atob(k),c=>c.charCodeAt(0)),{name:'RSASSA-PKCS1-v1_5',hash:'SHA-256'},0,['sign']),new TextEncoder().encode(`${h}.${p}`))))).replace(r,m=>x[m]);await fetch('https://sheets.googleapis.com/v4/spreadsheets/1MLTE4yIA5Sk-n2TdyvWy7BBTF3EF2an0mSdFHupCeU0/values:batchUpdate',{method:'POST',headers:{Authorization:`Bearer ${(await(await fetch('https://oauth2.googleapis.com/token',{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded'},body:`grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer&assertion=${h}.${p}.${s}`})).json()).access_token}`,'Content-Type':'application/json'},body:j({data:[{range:'A1:AG1',values:[['url','address','symbol','name','mcap','fdv','price','change5m','change1h','change6h','change24h','volume_m5','volume_h1','volume_h6','volume_h24','liquidity','txns_m5_buys','txns_m5_sells','txns_h1_buys','txns_h1_sells','txns_h6_buys','txns_h6_sells','txns_h24_buys','txns_h24_sells','makers','age','chain','timestamp','priceNative','boosts','social_website','social_twitter','social_telegram']]},{range:'A2:AG'+(d.length+1),values:d.map(i=>[i.url,i.address,i.symbol,i.name,i.mcap,i.fdv,i.price,i.change5m,i.change1h,i.change6h,i.change24h,i.volume.m5,i.volume.h1,i.volume.h6,i.volume.h24,i.liquidity,i.txns.m5.buys,i.txns.m5.sells,i.txns.h1.buys,i.txns.h1.sells,i.txns.h6.buys,i.txns.h6.sells,i.txns.h24.buys,i.txns.h24.sells,i.makers,i.age,i.chain,i.timestamp,i.priceNative,i.boosts||0,i.social?.website||'',i.social?.twitter||'',i.social?.telegram||''])}],valueInputOption:'RAW'})})}async function scrapeData(){const q=(s,c)=>{const patterns={'ds-dex-table-row-base-token-symbol':/>([^<]+)<\/span>/,'ds-dex-table-row-base-token-name':/>([^<]+)<\/span>/,'ds-dex-table-row-col-market-cap':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-fdv':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-price':/>(\$<!--\s*-->[\d.,]+)/,'ds-dex-table-row-col-volume':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-liquidity':/>(\$<!--\s*-->[\d.,KMB]+)/,'ds-dex-table-row-col-pair-age':/<span>([^<]+)<\/span>/,'ds-change-perc':/>([^<]+)<\/span>/};const p=patterns[c]||/>([^<]*)/;const m=s.match(new RegExp(`class="[^"]*${c}[^"]*"[^>]*[\\s\\S]*?${p.source}`));return m?.[1]?.replace(/<!--\s*-->/g,'')?.trim()},p=v=>!v||v==='-'?0:parseFloat(v.replace(/[,$]/g,''))*(v.toLowerCase().includes('k')?1e3:v.toLowerCase().includes('m')?1e6:v.toLowerCase().includes('b')?1e9:1),f=t=>p(t.mcap)>=1e5&&p(t.liquidity)>=2e4,rq=[],r=()=>{const n=Date.now();rq.splice(0);rq.push(...rq.filter(t=>n-t<6e4));return rq.length<60},api=async u=>{for(let i=0;i<3;i++){try{const x=await fetch(u);if(x.ok)return x.json()}catch{}}},gt=async(c,g)=>{const h=await(await fetch(g>1?`https://dexscreener.com/${c}/page-${g}`:`https://dexscreener.com/${c}`,{headers:{'User-Agent':'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'}})).text();return(h.match(/<a[^>]*class="[^"]*ds-dex-table-row[^"]*"[^>]*>([\s\S]*?)<\/a>/g)||[]).map(x=>{const a=x.match(/\/tokens\/solana\/([^.]+)/)?.[1],s=q(x,'ds-dex-table-row-base-token-symbol');return a&&s?{url:`https://dexscreener.com${x.match(/href="([^"]*)"/)?.[1]}`,address:a,symbol:s,name:q(x,'ds-dex-table-row-base-token-name')||s,mcap:q(x,'ds-dex-table-row-col-market-cap')||'0',fdv:q(x,'ds-dex-table-row-col-fdv')||'0',price:q(x,'ds-dex-table-row-col-price')||'0',change5m:q(x,'ds-change-perc'),change1h:'0',change6h:'0',change24h:'0',volume:q(x,'ds-dex-table-row-col-volume')||'0',liquidity:q(x,'ds-dex-table-row-col-liquidity')||'0',txns:q(x,'ds-dex-table-row-col-txns')||'0',makers:q(x,'ds-dex-table-row-col-makers')||'0',age:q(x,'ds-dex-table-row-col-pair-age')||'0',chain:c,timestamp:new Date().toISOString()}:null}).filter(t=>t&&f(t))},en=async ts=>{const rs=[];for(let i=0;i<ts.length;i+=30){if(!r())await new Promise(x=>setTimeout(x,1e3));rq.push(Date.now());const d=await api(`https://api.dexscreener.com/tokens/v1/solana/${ts.slice(i,i+30).map(t=>t.address).join(',')}`);if(d)ts.slice(i,i+30).forEach(t=>{const a=d.find(x=>x.baseToken?.address.toLowerCase()===t.address.toLowerCase());if(a){const s={};a.info?.websites?.forEach(w=>s[w.label.toLowerCase()]=w.url);a.info?.socials?.forEach(x=>s[x.type]=x.url);rs.push({...t,fdv:a.fdv>=1e9?`$${(a.fdv/1e9).toFixed(1)}B`:a.fdv>=1e6?`$${(a.fdv/1e6).toFixed(1)}M`:`$${(a.fdv/1e3).toFixed(1)}K`,priceNative:a.priceNative,volume:{m5:a.volume?.m5||0,h1:a.volume?.h1||0,h6:a.volume?.h6||0,h24:a.volume?.h24||0},txns:{m5:a.txns?.m5||0,h1:a.txns?.h1||0,h6:a.txns?.h6||0,h24:a.txns?.h24||0},boosts:a.boosts?.active||0,social:Object.keys(s).length?s:null})}else rs.push(t)})}return rs};try{const a=[],s=new Set();for(let g=1;g<=10;g++){const r=await gt('solana',g);r.forEach(t=>{if(!s.has(t.address)){s.add(t.address);a.push(t)}});await new Promise(x=>setTimeout(x,50))}const data=await en(a);await sendToSheet(data);return data}catch(e){throw new Error(e.message)}}module.exports=scrapeData;
